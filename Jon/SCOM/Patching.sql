/* PFGSCOMDBAGLI */
SELECT 
	dbe.ConnectionString_239AE8FB_36B6_4313_2085_3CEDE8EC17EB as SQLServerInstance,
	CASE
		WHEN dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68] LIKE '7%' THEN 'SQL Server 7' 
		WHEN dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68] LIKE '8%' THEN 'SQL Server 2000'
		WHEN dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68] LIKE '9%' THEN 'SQL Server 2005'
		WHEN dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68] LIKE '10.5%' THEN 'SQL Server 2008R2'
		WHEN dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68] LIKE '10%' THEN 'SQL Server 2008'
		WHEN dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68] LIKE '11%' THEN 'SQL Server 2012'
		WHEN dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68] LIKE '12%' THEN 'SQL Server 2014'
		WHEN dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68] LIKE '13%' THEN 'SQL Server 2016'
		ELSE 'unknown'
	END AS [version],
	dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68] AS SQL_Version,
	CASE 
		WHEN (dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68]) LIKE '9%' AND LEFT(dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68],3) < '9.4' THEN 'Patching Required'
		WHEN (dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68]) LIKE '10.5%' AND LEFT(dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68],5) < '10.53' THEN 'Patching Required'
		WHEN (dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68]) LIKE '10%' AND LEFT(dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68],4) < '10.4' THEN 'Patching Required'
		WHEN (dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68]) LIKE '11%' AND LEFT(dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68],4) < '11.3' THEN 'Patching Required'
		WHEN (dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68]) LIKE '12%' AND LEFT(dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68],4) < '12.1' THEN 'Patching Required'
		WHEN (dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68]) LIKE '13%' AND LEFT(dbe.[Version_F88DED9E_01CE_C201_1889_BF46DFC5CD68],4) < '13.1' THEN 'Patching Required'
		ELSE 'Patched'
	END AS Patched,
	LEFT(Edition_C294089D_3FBF_002E_06D8_2FAB53D11788,CHARINDEX(' ',Edition_C294089D_3FBF_002E_06D8_2FAB53D11788)-1) AS edition
FROM [MTV_Microsoft$SQLServer$DBEngine] dbe
WHERE BaseManagedEntityId IN (SELECT BaseManagedEntityId FROM stateview WHERE operationalstate IS NOT null)

UNION ALL

SELECT
    ConnectionString_2975EC85_56B8_A1F4_4499_E9B36E15A99A as SQLServerInstance,
    'SQL Server 2014',
	Version_72FC038A_B9AD_7147_F36E_E6CE52D0CC6C AS SQL_Version,
	CASE 
	WHEN (Version_72FC038A_B9AD_7147_F36E_E6CE52D0CC6C) LIKE '12%' AND LEFT(Version_72FC038A_B9AD_7147_F36E_E6CE52D0CC6C,4) < '12.1' THEN 'Patching Required'
	ELSE 'Patched'
END AS Patched,
    LEFT(Edition_7A07B1B0_9FEF_245F_8B9A_1125AAA62114,CHARINDEX(' ',Edition_7A07B1B0_9FEF_245F_8B9A_1125AAA62114)-1)
FROM [MTV_Microsoft$SQLServer$2014$DBEngine]
WHERE BaseManagedEntityId IN (SELECT BaseManagedEntityId FROM stateview WHERE operationalstate IS NOT null)
ORDER BY version, SQL_version


--9.00.5057.00